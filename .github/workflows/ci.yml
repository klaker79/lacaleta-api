name: Backend CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: ci_user
          POSTGRES_PASSWORD: ci_password_123
          POSTGRES_DB: lacaleta_ci
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      # Database
      DATABASE_URL: postgresql://ci_user:ci_password_123@localhost:5432/lacaleta_ci
      DB_HOST: localhost
      DB_PORT: 5432
      DB_NAME: lacaleta_ci
      DB_USER: ci_user
      DB_PASSWORD: ci_password_123

      # Auth
      JWT_SECRET: ci-test-secret-key-minimum-32-characters-long!!
      INVITATION_CODE: CI_TEST_INVITE_2026

      # Server
      PORT: 3001
      NODE_ENV: test
      API_URL: http://localhost:3001
      ALLOWED_ORIGINS: http://localhost:3001

      # Test user (used by tests/setup.js)
      TEST_USER_EMAIL: ci-test@mindloop.dev
      TEST_USER_PASSWORD: CiTest123!

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint

      - name: Start server (background)
        run: node server.js &

      - name: Wait for server and DB to be ready
        run: |
          echo "Waiting for server to start..."
          for i in $(seq 1 30); do
            if curl -s http://localhost:3001/api/health > /dev/null 2>&1; then
              echo "✅ Server is responding"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "❌ Server failed to start"
              exit 1
            fi
            sleep 1
          done
          echo "Waiting for DB tables..."
          sleep 5

      - name: Register test user
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt to register test user..."
            BODY=$(curl -s -w "\n%{http_code}" \
              -X POST http://localhost:3001/api/auth/register \
              -H "Content-Type: application/json" \
              -H "Origin: http://localhost:3001" \
              -d '{
                "nombre": "CI Test User",
                "email": "ci-test@mindloop.dev",
                "password": "CiTest123!",
                "codigoInvitacion": "CI_TEST_INVITE_2026"
              }')
            HTTP_CODE=$(echo "$BODY" | tail -1)
            RESPONSE=$(echo "$BODY" | sed '$d')
            echo "Status: $HTTP_CODE | Body: $RESPONSE"
            if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "400" ]; then
              echo "✅ Test user ready"
              exit 0
            fi
            echo "Retrying in 3s..."
            sleep 3
          done
          echo "❌ Registration failed after 3 attempts"
          exit 1

      - name: Run tests
        run: npx jest --runInBand --forceExit --testPathIgnorePatterns='rate-limiting|auth-flows'

      - name: Run auth-flows tests (isolated — logout revokes tokens)
        run: npx jest tests/critical/auth-flows.test.js --runInBand --forceExit

      - name: Run rate-limiting tests (last — triggers brute-force protection)
        run: npx jest tests/critical/rate-limiting-auth.test.js --runInBand --forceExit


